# 元素

> 本文出现的 “元素”，若非特殊声明，一律指代 “React 元素”。

什么是元素？按照[官网的描述](https://reactjs.org/docs/rendering-elements.html)，元素是组成 React 应用的最小单元。具体一点，元素就是 JavaScript 对象，我们可以称之为元素对象。

## 1. JSX

在开发 React 应用时，通常会使用 JSX 语法代替直接使用 `React.createElment()` 来创建元素。JSX 通过 Babel 转译后同样是使用 `React.createElment()` 来创建元素。例如：

```jsx
<h1>Hello, world!</h1>
```

通过 Babel 转译后生成：

```js
React.createElement('h1', null, 'Hello, world!');
```

注意，转译后的代码使用了 `React` 命名空间，所以在使用 JSX 时会要求导入 React。

## 2. 元素对象

`React.createElment()` 方法创建元素。其语法为：

```js
React.createElement(type, [props], [...children]);
```

返回的[结构](https://github.com/facebook/react/blob/17.0.1/packages/react/src/ReactElement.js#L126)如下（省略部分不重要的字段）：

```ts
interface ReactElement {
  // 标识符，标记一个对象是 React 元素，值为 `Symbol.for('react.element')`
  $$typeof: symbol;
  // 元素类型，包括用户组件、DOM 元素、React 元素类型
  type: any;
  // 从属性对象 props 中获取的 key
  key: any;
  // 从属性对象 props 中获取的 ref
  ref: any;
  // 属性对象，移除了 key 和 ref 属性，并将 chilren 合并
  props: any;
}
```

根据上面的结构，在判断一个对象是否是 React 元素时便非常容易，只需要判断对象中是否有 React 元素标识符即可：

```js
function isValidElement(object) {
  return (
    typeof object === 'object' &&
    object !== null &&
    object.$$typeof === Symbol.for('react.element')
  );
}
```

React 提供 `React.isValidElement()` 方法来判断一个对象是否是一个 React 元素，其内部实现与上面的判断方式一模一样。

## 3. `React.createElement()`

从[源码](https://github.com/facebook/react/blob/17.0.1/packages/react/src/ReactElement.js#L344)分析，`React.createElement()` 的执行过程主要分为以下几步：

1. 移除属性对象中的 `key` 和 `ref`。
1. 合并 `children` 到属性对象中，会覆盖属性对象中原有的 `children` 属性。
1. 合并默认属性 `defaultProps` 的值到属性对象中。

```js
function createElement(type, config, ...children) {
  const props = {};
  let key = null;
  let ref = null;

  // 移除属性对象中的 `key` 和 `ref`。
  if (config != null) {
    if (config.key != null) key = '' + config.key;
    if (config.ref != null) ref = config.ref;

    for (const name in config) {
      if (
        Object.prototype.hasOwnProperty.call(config, name) &&
        !['key', 'ref'].includes(name)
      ) {
        props[name] = config[name];
      }
    }
  }

  // 合并 `children` 到属性对象中，会覆盖属性对象中原有的 `children` 属性。
  if (children.length) {
    if (children.length === 1) {
      props.children = children[0];
    } else {
      props.children = children;
    }
  }

  // 合并默认属性 `defaultProps` 的值到属性对象中。
  if (type && type.defaultProps) {
    const defaultProps = type.defaultProps;

    for (const name in defaultProps) {
      if (props[name] === undefined) {
        props[name] = defaultProps[name];
      }
    }
  }

  return {
    $$typeof: Symbol.for('react.element'),
    type,
    key,
    ref,
    props,
  };
}
```

## 4. 应用中的元素

下面以一个[简单的示例](https://babeljs.io/en/repl#?browsers=defaults%2C%20not%20ie%2011%2C%20not%20ie_mob%2011&build=&builtIns=false&spec=false&loose=false&code_lz=JYWwDg9gTgLgBAJQKYEMDGMA0cDecDCE4EAdkifAL5wBmURcA5FKhowNwBQoksirMACIB5ALK16IJi3QwAtABMiHTpzQAbFAGctcAIJgwcJAA8Y5BbsLEyFXJzhwWJBUigAKAJT3HjljABXKBI4dwdfRwAeFFhgDSQAPnCIqIALAEYE0QBPOAAZYBokSIB6DKSU30iwBIKiuGBdAHdSVygaAPUAOlKa5KqSmJg49UT-zy5HSk5pzmRZEVEu5zb3SIMjEoTsJTQAkHIYLoBzJBgAUVGDigAhbIBJBXdmCAgYRk8JoA&debug=false&forceAllTransforms=false&shippedProposals=false&circleciRepo=&evaluate=false&fileSize=false&timeTravel=false&sourceType=module&lineWrap=true&presets=react&prettier=false&targets=&version=7.12.12&externalPlugins=%40babel%2Fplugin-proposal-class-properties%407.12.1)来窥探元素在应用中是如何被创建的。

```jsx
import React, { Component } from 'react';
import ReactDOM from 'react-dom';

class App extends Component {
  render() {
    return (
      <article>
        <h1>My Life</h1>
        <p>Life is wonderful.</p>
      </article>
    );
  }
}

ReactDOM.render(<App />, document.getElementById('root'));
```

通过 Babel 转译后的代码：

```js
import React, { Component } from 'react';
import ReactDOM from 'react-dom';

class App extends Component {
  render() {
    return React.createElement(
      'article',
      null,
      React.createElement('h1', null, 'My Life'),
      React.createElement('p', null, 'Life is wonderful.')
    );
  }
}

ReactDOM.render(
  React.createElement(App, null),
  document.getElementById('root')
);
```

需要注意的是，只有 `<App />` 元素是一开始就创建的，`App` 组件内部的元素是在渲染过程中创建的，也就是在 `ReactDOM.render()` 方法执行过程中创建的。

## 5. 总结

- 元素就是 JavaScript 对象。
- 元素通过 `React.createElement()` 方法创建。
- JSX 语法最终会转译为 `React.createElement()`。
- 元素类型包括：用户组件、DOM 元素、React 元素类型。下个章节会进行详解。
- 在应用中，除了入口元素是一开始就创建的，其余的元素都是在渲染过程（`ReactDOM.render()` 方法的执行过程）中创建的。
